<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>云安全 | My Hugo Knowledgebase</title>

    <link rel="stylesheet" href="/css/main.css">


      <script src="/js/main.js"></script>


</head>
<body>
  <header>
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
  <a href="/" style="font-weight: bold; font-size: 1.2em; text-decoration: none; color: var(--text-color);">My Hugo Knowledgebase</a>
  <button id="theme-toggle" class="theme-toggle" aria-label="Toggle Dark Mode" style="font-size: 0.9em;">
    Theme
  </button>
</div>

  </header>
  <main>
    
  <h1>云安全</h1>
  
  
    <section>
      <h2><a href="/blog/%E4%BA%91%E5%AE%89%E5%85%A8/docker%E5%AE%89%E5%85%A8/">Docker安全</a></h2>
      
    </section>
  
    <section>
      <h2><a href="/blog/%E4%BA%91%E5%AE%89%E5%85%A8/k8s%E5%AE%89%E5%85%A8/">K8s安全</a></h2>
      
    </section>
  
    <section>
      <h2><a href="/blog/%E4%BA%91%E5%AE%89%E5%85%A8/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">云原生基础知识</a></h2>
      <h1 id="云原生基础知识">云原生基础知识</h1>
<p>正式开始云原生安全的学习，首先了解一下相关的基础知识</p>
<h2 id="常见名词">常见名词</h2>
<p>记录一些常见的专业术语的意思</p>
<h3 id="容器">容器</h3>
<p>这玩意打CTF的应该都比较熟悉</p>
<blockquote>
<p>Docker 是一个开放源代码软件，是一个开放平台，用于开发应用、交付（shipping）应用、运行应用。Docker允许用户将基础设施（Infrastructure）中的应用单独分割出来，形成更小的颗粒（容器），从而提高交付软件的速度</p>
</blockquote>
<p>Docker 容器与虚拟机类似，但二者在原理上不同:</p>
<ul>
<li>容器是将操作系统层虚拟化</li>
<li>虚拟机是虚拟化硬件</li>
</ul>
<p>按照上面的比较，可以知道容器能更便携高效地利用服务器</p>
<p>接下来一下Docker官方给出的架构图：</p>
<p><img src="https://yuy0ung.oss-cn-chengdu.aliyuncs.com/7868545-060cc40d94102469.jpg" alt="img"></p>
<p>可以看见里面包括了Docker客户端、Docker容器所在宿主机、Docker镜像仓库三部分</p>
<p>而宿主机包括了Docker守护进程、本地容器、本地镜像，Docker守护进程Dockerd的作用是侦听Docker API请求和管理Docker对象</p>
<h3 id="容器编排">容器编排</h3>
<p>容器编排（Container Orchestration）是指自动化容器的部署、管理、扩展和联网，容器编排可以为需要部署和管理成百上千个 Linux 容器和主机的企业提供便利</p>
<p>常见的容器编排工具方案有 Kubernetes、Docker Swarm 和 Apache Mesos 等</p>
<h3 id="无服务">无服务</h3>
<p>无服务（serverless）是一种云原生开发模型，可使开发人员专注构建和运行应用，简单来说，就是开发者不用去管服务器只负责开发就行</p>
<p>无服务计算产品通常被分为两类，分别是后端即服务（BaaS）和函数即服务（FaaS），其中 FaaS 是 Serverless  的主要实现方式，FaaS 的相关产品主要有 AWS 的 Lambda、Azure 的  Functions Serverless  Compute、GCP 的 Firebase Cloud Functions、阿里云的 Function Compute 等</p>
<h3 id="微服务">微服务</h3>
<p>微服务（Microservices）是一种软件架构风格，它是以专注于单一责任与功能的小型功能区块为基础，利用模块化的方式组合出复杂的大型应用程序，各功能区块使用与语言无关的API集相互通信</p>
<h3 id="服务网格">服务网格</h3>
<p>服务网格（Service Mesh）用于控制应用的不同部分之间如何共享数据，服务网格内置于应用程序中的专用基础架构层，这个可见的基础架构层可以记录应用的不同部分是否能正常交互</p>
<h2 id="云原生安全">云原生安全</h2>
<h3 id="云原生">云原生</h3>
<ul>
<li><strong>云</strong>：运行在云服务器上</li>
<li><strong>原生</strong>：将应用运行到云上，充分的利用云自身的特点，比如弹性和分布式优势（且业务按照云来设计，而不是简单迁移）</li>
</ul>
<p>云原生技术有利于各组织在公有云、私有云和混合云等新型动态环境中，构建和运行可弹性扩展的应用。云原生的代表技术包括容器、服务网格、微服务、不可变基础设施和声明式 API</p>
<h3 id="云原生安全-1">云原生安全</h3>
<p>云原生安全至少包含了微服务安全、无服务安全、编排平台安全、服务网格安全、容器安全、宿主机安全等等。</p>
<p>根据云原生环境的构成，面向云原生环境的安全体系可以概括为以下三个层面：</p>
<ul>
<li>容器安全</li>
<li>编排系统安全</li>
<li>云原生应用安全：包括了微服务、无服务、服务网格、零信任体系、API 安全等等</li>
</ul>
<p>另外除了这些和云原生环境相关的技术之外，云原生安全还包含了一些传统安全的内容，比如宿主机的安全等等。</p>
    </section>
  
    <section>
      <h2><a href="/blog/%E4%BA%91%E5%AE%89%E5%85%A8/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%AD%A6%E4%B9%A0/">云服务学习</a></h2>
      <h1 id="云服务学习">云服务学习</h1>
<p>云服务就是云上的服务，比如从云厂商（AWS、阿里云）买来的服务</p>
<p>国内云厂商：</p>
<ul>
<li>阿里云</li>
<li>腾讯云</li>
<li>华为云</li>
<li>天翼云</li>
<li>Ucloud</li>
<li>金山云</li>
<li>&hellip;&hellip;</li>
</ul>
<p>国外云厂商：</p>
<ul>
<li>AWS</li>
<li>GCP</li>
<li>Azure</li>
<li>&hellip;&hellip;</li>
</ul>
<p>每个云厂商对云服务的叫法不同，这里以AWS的为例：</p>
<ul>
<li>S3对象存储（Simple Storage Service），可以简单理解为网盘，略有区别</li>
<li>EC2弹性计算服务（Elastic Computer Cloud），简单理解为云上的虚拟机</li>
<li>RDS云数据库（Relational Database Service），简单理解为云上数据库</li>
<li>IAM身份管理和访问管理（Identity and Access Management），简单理解为云控制台上的一套身份管理服务，可以用来管理每个子账号的权限</li>
</ul>
<p>综上来看，其实可以简单看作一些本地的功能/服务放到了云上，那么就会产生对应的风险，值得研究</p>
<p>在下文的案例图片中，笔者可能会更多用国内厂商（比如aliyun）进行举例，漏洞实例使用<a href="https://github.com/HXSecurity/TerraformGoat">TerraformGoat</a>靶场进行演示</p>
<p>学习顺序参考https://wiki.teamssix.com/</p>
<h2 id="对象存储">对象存储</h2>
<p>对象存储（Object-Based Storage），也可以叫做面向对象的存储，现在也有不少厂商直接把它叫做云存储，很经典的就是Amazon S3 (Simple Storage Service) 简单存储服务，是 Amazon 的公开云存储服务，与之对应的协议被称为 S3 协议，目前 S3 协议已经被视为公认的行业标准协议，因此目前国内主流的对象存储厂商基本上都会支持 S3 协议</p>
<p>Amazon S3标准中，对对象存储中可以有多个桶（Bucket），而对象（object）存放在桶里，对象包含三个<code>key</code>、<code>Data</code>、<code>Metadata</code>部分：</p>
<p><img src="https://yuy0ung.oss-cn-chengdu.aliyuncs.com/image-20250220033100066.png" alt="image-20250220033100066"></p>
<ul>
<li><strong>Key</strong>指存储桶中的唯一标识符，例如一个 URL 为：<code>https://yuy0ung.s3.ap-northeast-2.amazonaws.com/d0g3</code>，这里的 yuy0ung 是存储桶 Bucket 的名称，<code>/d0g3</code> 就是 Key</li>
<li><strong>Data</strong>很好理解，就是存储的数据本体</li>
<li><strong>Metadata</strong>意味元数据，可以简单理解为数据的标签、描述之类的信息（区别于传统的文件存储，在传统的文件存储中这类信息是直接封装在文件里的，而云上有了元数据的存在，可以大大的加快对象的排序、分类和查找）</li>
</ul>
<p>操作使用Amazon S3的方式大致如下：</p>
<ul>
<li>AWS 控制台操作</li>
<li>AWS 命令行工具操作</li>
<li>AWS SDK 操作</li>
<li>REST API 操作，通过 REST API，可以使用 HTTP 请求创建、提取和删除存储桶和对象</li>
</ul>
<p>接下来记录S3相关攻击手法</p>
    </section>
  
    <section>
      <h2><a href="/blog/%E4%BA%91%E5%AE%89%E5%85%A8/%E8%AF%86%E5%88%AB%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BAdocker%E5%92%8Ck8s%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83/">识别虚拟主机、Docker和K8s集群环境</a></h2>
      <h1 id="识别虚拟主机docker和k8s集群环境">识别虚拟主机、Docker和K8s集群环境</h1>
<h3 id="一基础">一、基础</h3>
<p>随着云原生应用不断普及，在我们getshell之后，我们还需要判断该shell是否处于虚拟环境中，并判断该虚拟环境的类型，通常情况下，shell的虚拟环境可能有如下三个类型：</p>
<ul>
<li>
<h5 id="虚拟主机"><strong>虚拟主机</strong></h5>
<p>虚拟主机是指在一台物理服务器上运行的多个虚拟主机实例，每个虚拟主机实例都拥有自己的环境和资源，通常用于提供Web托管服务</p>
<p><strong>注意</strong>：虚拟主机（Virtual Hosting）和虚拟机（Virtual Machine）是两个不同的概念，虚拟机是一个完整的虚拟化系统，包括操作系统、软件和硬件，可以在单个物理服务器上运行多个操作系统实例</p>
</li>
<li>
<h5 id="docker"><strong>Docker</strong></h5>
<p>Docker是一种虚拟化技术，利用容器化的方式将应用程序及其依赖项打包成独立、轻量级的环境，实现快速部署、高效运行和跨平台运行的功能</p>
</li>
<li>
<h5 id="k8s"><strong>K8s</strong></h5>
<p>Kubernetes（通常简写为K8s）是一个开源的容器编排平台，通过自动化部署、扩展和管理容器化应用，实现高可用性、弹性和灵活性。它提供了集群管理、服务发现、负载均衡等功能，让用户可以更轻松地管理容器化应用的生命周期</p>
</li>
</ul>
<h3 id="二思路">二、思路</h3>
<p>如果shell处于虚拟主机、Docker或K8s集群环境中，我们需要对环境进行识别，并采取针对性的措施，比如：</p>
<ul>
<li>
<p><strong>虚拟主机</strong>：通常考虑横向移动来扩大攻击效果</p>
</li>
<li>
<p><strong>Docker</strong>：通常先进行容器逃逸，再进行内网横向移动</p>
</li>
<li>
<p><strong>K8s</strong>：通常先尝试接管集群，以获取对容器和集群资源的完全控制</p>
</li>
</ul>
<h3 id="三识别">三、识别</h3>
<p>首先判断当前shell是否采用了虚拟化技术：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>systemd-detect-virt		<span style="color:#75715e">#识别系统虚拟机（VM）、容器还是裸机上运行</span>
</span></span></code></pre></div><p>在确认采用了虚拟化技术后，常有如下检测方法可以快速识别当前所处环境类型</p>
<ul>
<li>
<h5 id="查看主机名和进程"><strong>查看主机名和进程</strong></h5>
<p>容器的主机名默认随机生成的字符串，PID1非系统进程，可初步判断当前为容器环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>hostname	<span style="color:#75715e">#查看主机名</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ps aux		<span style="color:#75715e">#显示系统上所有用户的详细进程信息</span>
</span></span></code></pre></div></li>
<li>
<h5 id="通过利用cgroup信息的差异"><strong>通过利用cgroup信息的差异</strong></h5>
<p>通过查看cgroup信息，可以判断当前环是否是虚拟机、Docker容器或K8s集群:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat /proc/1/cgroup	<span style="color:#75715e">#用于查看进程ID为1的系统进程（通常是Init进程）所属的cgroup信息，即用于控制和管理进程资源使用的容器技术</span>
</span></span></code></pre></div><p>也可以针对性的查找关键词，例如针对Docker字符串：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>grep <span style="color:#e6db74">&#39;docker&#39;</span> /proc/1/cgroup	<span style="color:#75715e">#查找是否存在‘Docker’字符串</span>
</span></span></code></pre></div></li>
<li>
<p><strong>检查根目录下.dockerenv文件</strong></p>
<p>通过判断根目录下的.dockerenv文件是否存在，确认当前环是否为容器环境:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ls -alh/dockerenv	<span style="color:#75715e">#列出/dockerenv目录下的所有文件和目录，并显示详细信息以及人类可读的文件大小</span>
</span></span></code></pre></div></li>
<li>
<p><strong>通过检查挂载信息</strong></p>
<p>通过检查挂载信息，推测当前环境是虚拟机、Docker容器还是K8s集群:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mount lgrep <span style="color:#e6db74">&#39;/type&#39;</span>	<span style="color:#75715e">#从当前系统中列出所有已挂载的文件系统，并使用grep命令筛选出包含/type路径的挂载信息</span>
</span></span></code></pre></div></li>
<li>
<p><strong>查看硬盘信息</strong></p>
<p>通过查看硬盘信息，推断当前环境是否为容器环境:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>fdisk -l <span style="color:#75715e">#列出系统上所有磁盘的分区信息</span>
</span></span></code></pre></div></li>
<li>
<p><strong>获取当前环境的文件系统和挂载点信息</strong></p>
<p>获取当前环境的文件系统和挂载点信息，用来判断是否容器环境:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>df -h	<span style="color:#75715e">#显示文件系统的磁盘使用情况和挂载点信息</span>
</span></span></code></pre></div></li>
<li>
<p><strong>通过了解环境变量包含的信息</strong></p>
<p>通过检查环境变量，了解特定环境的信息:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>env 	<span style="color:#75715e">#显示当前系统环境中的所有环境变量</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="四反制">四、反制</h3>
<p>对于防守者而言，通过了解攻击者在云原生环境中可能采取的这些信息探测行为，可以建立有效的告警机制，以便及早发现潜在的攻击行为</p>
    </section>
  

  </main>
  <footer>
    <p>Copyright 2025. All rights reserved.</p>

  </footer>
</body>
</html>
